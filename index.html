<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Keuangan PGRI - Optimized</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="https://ktadigitalpgri.org/assets/dist/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .bank-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card-red { background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%); }
        .card-green { background: linear-gradient(135deg, #064e3b 0%, #059669 100%); }
        
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #sidebar { transition: 0.3s; z-index: 1001; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; }

        @media print {
            .no-print, button, .filter-area, #sidebar, .overlay, #loading-screen { display: none !important; }
            body { background: white; padding: 0; }
            #konten { display: block !important; max-width: 100% !important; }
            .print-area { box-shadow: none !important; border: 1px solid #ddd !important; width: 100% !important; border-radius: 0 !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000 !important; padding: 6px !important; font-size: 10px !important; color: black !important; }
            .bank-gradient, .card-red, .card-green { color: black !important; background: none !important; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="overlay" class="overlay no-print" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-[-280px] h-full w-[280px] bg-slate-900 text-white p-6 no-print shadow-2xl">
        <h2 class="text-xl font-black italic mb-10 border-b border-slate-700 pb-4 text-orange-500">MENU UTAMA</h2>
        <nav class="space-y-4">
            <button onclick="pindahHalaman('rekap')" class="w-full text-left p-4 hover:bg-slate-800 rounded-2xl font-bold flex items-center gap-3">üìä REKAP IURAN</button>
            <button onclick="pindahHalaman('pengeluaran')" class="w-full text-left p-4 hover:bg-slate-800 rounded-2xl font-bold flex items-center gap-3">üí∏ PENGELUARAN</button>
        </nav>
        <p class="absolute bottom-6 text-[10px] text-slate-500 font-bold uppercase">E-Bendahara v2.0</p>
    </div>

    <div id="loading-screen" class="loader-container no-print">
        <div class="spinner mb-4"></div>
        <p class="text-slate-500 font-bold animate-pulse">MEMPROSES DATA KEUANGAN...</p>
    </div>

    <div id="konten" class="hidden max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-8 no-print">
            <button onclick="toggleSidebar()" class="bg-slate-800 text-white p-3 rounded-xl shadow-lg hover:bg-slate-700 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>
            </button>
            <div class="text-right">
                <h1 class="text-2xl font-black text-slate-800 uppercase italic leading-none" id="judul-halaman">REKAP IURAN</h1>
                <p class="text-slate-500 text-[9px] font-bold tracking-widest uppercase mt-1">Sistem Keuangan Digital PGRI</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 no-print">
            <div class="bank-gradient p-6 rounded-[30px] text-white shadow-xl">
                <p class="text-[9px] font-bold uppercase text-slate-400">Total Iuran (+)</p>
                <h3 id="dash-iuran" class="text-xl font-black text-orange-400">Rp 0</h3>
            </div>
            <div class="card-red p-6 rounded-[30px] text-white shadow-xl">
                <p class="text-[9px] font-bold uppercase text-red-200">Total Pengeluaran (-)</p>
                <h3 id="dash-keluar" class="text-xl font-black text-white">Rp 0</h3>
            </div>
            <div class="card-green p-6 rounded-[30px] text-white shadow-xl">
                <p class="text-[9px] font-bold uppercase text-emerald-100">Saldo Akhir</p>
                <h3 id="dash-saldo" class="text-xl font-black text-white">Rp 0</h3>
            </div>
        </div>

        <div id="halaman-rekap">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 no-print">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">Unit Cabang</label>
                    <select id="filter-cabang" onchange="jalankanFilter()" class="w-full bg-slate-50 p-2 rounded-lg font-bold text-slate-700 outline-none text-sm"></select>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">Periode Bulan</label>
                    <select id="filter-periode" onchange="jalankanFilter()" class="w-full bg-slate-50 p-2 rounded-lg font-bold text-slate-700 outline-none text-sm"></select>
                </div>
            </div>

            <div class="bg-white rounded-[30px] shadow-sm border border-slate-100 overflow-hidden print-area p-4">
                <div class="flex gap-2 mb-4 no-print">
                    <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase flex items-center gap-2">
                        <i class="fas fa-print"></i> Cetak Data / PDF
                    </button>
                    <button onclick="exportKeExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase flex items-center gap-2">
                        <i class="fas fa-file-excel"></i> Ekspor ke Excel
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table id="tabel-rekap" class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <th class="p-6">Waktu & Periode</th>
                                <th class="p-6">Cabang</th>
                                <th class="p-6 text-center">Anggota</th> 
                                <th class="p-6 text-right">Nominal</th>
                                <th class="p-6 text-center no-print">Bukti</th>
                            </tr>
                        </thead>
                        <tbody id="isi-tabel-iuran" class="divide-y divide-slate-50 text-sm font-medium text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="halaman-pengeluaran" class="hidden">
            <div class="bg-white p-6 rounded-[30px] shadow-sm border border-slate-200 mb-8 no-print">
                <h4 class="font-black text-slate-800 mb-4 uppercase text-sm">Input Data Pengeluaran</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="exp-tgl" class="bg-slate-100 p-3 rounded-xl text-sm outline-none font-bold">
                    <input type="text" id="exp-nama" placeholder="Nama Pengeluaran" class="bg-slate-100 p-3 rounded-xl text-sm outline-none font-bold">
                    <input type="text" id="exp-nominal" placeholder="Nominal Rp" oninput="formatRupiah(this)" class="bg-slate-100 p-3 rounded-xl text-sm outline-none font-bold">
                    <button onclick="simpanPengeluaran()" id="btn-save-exp" class="bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 shadow-lg uppercase text-xs">Simpan Data</button>
                </div>
            </div>

            <div class="bg-white p-5 rounded-[25px] shadow-sm border border-slate-200 mb-6 no-print mx-1">
                <label class="text-[10px] font-black text-orange-500 uppercase mb-2 block tracking-widest">Cari Berdasarkan Tahun & Bulan</label>
                <div class="relative">
                    <select id="filter-periode-keluar" onchange="jalankanFilterPengeluaran()" class="w-full bg-slate-100 p-4 rounded-xl font-black text-slate-800 outline-none text-base appearance-none border-2 border-orange-200 focus:border-orange-500 transition-all cursor-pointer">
                        </select>
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-orange-500">
                        <i class="fas fa-calendar-alt fa-lg"></i>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mb-4 no-print px-4">
                <button onclick="window.print()" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 transition-all flex items-center shadow-md">
                    <i class="fas fa-print mr-2"></i> Cetak Pengeluaran
                </button>
                <button onclick="exportExcelPengeluaran()" class="bg-orange-600 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-700 transition-all flex items-center shadow-md">
                    <i class="fas fa-file-excel mr-2"></i> ekspor pengeluaran
                </button>
            </div>

            <div class="bg-white rounded-[30px] shadow-sm border border-slate-100 overflow-hidden print-area p-4">
                <table id="tabel-pengeluaran" class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="p-6">Tanggal</th>
                            <th class="p-6">Nama Pengeluaran</th>
                            <th class="p-6 text-right">Nominal</th>
                        </tr>
                    </thead>
                    <tbody id="isi-tabel-keluar" class="divide-y divide-slate-50 text-sm font-medium text-slate-700"></tbody>
                </table>
            </div>
        </div>        

        <p class="text-center text-[9px] text-slate-400 mt-8 uppercase font-bold tracking-[0.3em]">Laporan diperbarui otomatis: <span id="waktu-skrg"></span></p>
    </div>

    <script>
        const linkScript = 'https://script.google.com/macros/s/AKfycbyhtrnyZ3X8BJNm2maiC2V06MKAq0r6Fkeg67maSok0moYtO1vGXTjv9fIxcJmn_V2v/exec';
        let DATA_IURAN = [];
        let DATA_KELUAR = [];

        window.onload = ambilData;

        function toggleSidebar() {
            const side = document.getElementById('sidebar');
            const over = document.getElementById('overlay');
            if(side.style.left === '0px') {
                side.style.left = '-280px';
                over.style.display = 'none';
            } else {
                side.style.left = '0px';
                over.style.display = 'block';
            }
        }

        function pindahHalaman(hal) {
            if(hal === 'rekap') {
                document.getElementById('halaman-rekap').classList.remove('hidden');
                document.getElementById('halaman-pengeluaran').classList.add('hidden');
                document.getElementById('judul-halaman').innerText = 'REKAP IURAN';
            } else {
                document.getElementById('halaman-rekap').classList.add('hidden');
                document.getElementById('halaman-pengeluaran').classList.remove('hidden');
                document.getElementById('judul-halaman').innerText = 'PENGELUARAN';
            }
            toggleSidebar();
        }

        async function ambilData() {
            try {
                const res = await fetch(linkScript);
                const data = await res.json();
                DATA_IURAN = data.iuran || [];
                DATA_KELUAR = data.pengeluaran || [];
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('konten').classList.remove('hidden');
                document.getElementById('waktu-skrg').innerText = new Date().toLocaleString('id-ID');
                hitungDashboard();
                buatPilihanFilter();
                jalankanFilter();
                tampilkanPengeluaran();
            } catch (e) {
                alert("Gagal koneksi database!");
            }
        }

        function hitungDashboard() {
            let totalIuran = DATA_IURAN.reduce((acc, curr) => acc + (parseInt(curr.total) || 0), 0);
            let totalKeluar = DATA_KELUAR.reduce((acc, curr) => acc + (parseInt(curr.nominal) || 0), 0);
            document.getElementById('dash-iuran').innerText = "Rp " + totalIuran.toLocaleString('id-ID');
            document.getElementById('dash-keluar').innerText = "Rp " + totalKeluar.toLocaleString('id-ID');
            document.getElementById('dash-saldo').innerText = "Rp " + (totalIuran - totalKeluar).toLocaleString('id-ID');
        }

        function buatPilihanFilter() {
            const daftarCabang = new Set(['Semua Cabang']);
            const daftarPeriode = new Set(['Semua Bulan']);
            const daftarPeriodeKeluar = new Set(['Semua Bulan']);

            DATA_IURAN.forEach(d => {
                if(d.cabang) daftarCabang.add(d.cabang);
                if(d.periode) daftarPeriode.add(d.periode);
            });

            // LOGIKA PINTAR DETEKSI TAHUN-BULAN
            DATA_KELUAR.forEach(d => {
                if(d.tgl) {
                    let p;
                    if (d.tgl.includes('-')) {
                        // Jika format YYYY-MM-DD
                        p = d.tgl.substring(0, 7);
                    } else if (d.tgl.includes('/')) {
                        // Jika format DD/MM/YYYY
                        const parts = d.tgl.split('/');
                        p = parts[2] + '-' + parts[1];
                    } else {
                        p = d.tgl.substring(0, 7);
                    }
                    if(p && p.length >= 4) daftarPeriodeKeluar.add(p);
                }
            });

            document.getElementById('filter-cabang').innerHTML = Array.from(daftarCabang).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('filter-periode').innerHTML = Array.from(daftarPeriode).map(p => `<option value="${p}">${p}</option>`).join('');
            
            let htmlKeluar = '<option value="Semua Bulan">üìÖ SEMUA DATA PENGELUARAN</option>';
            const sortedPeriode = Array.from(daftarPeriodeKeluar).filter(x => x !== 'Semua Bulan').sort().reverse();
            
            sortedPeriode.forEach(p => {
                // Tampilkan Tahun-Bulan dengan format besar
                htmlKeluar += `<option value="${p}">TAHUN: ${p.split('-')[0]} | BULAN: ${p.split('-')[1] || '-'}</option>`;
            });
            document.getElementById('filter-periode-keluar').innerHTML = htmlKeluar;
        }

        function jalankanFilter() {
            const cab = document.getElementById('filter-cabang').value;
            const per = document.getElementById('filter-periode').value;
            const filtered = DATA_IURAN.filter(d => (cab === 'Semua Cabang' || d.cabang === cab) && (per === 'Semua Bulan' || d.periode === per));
            let html = '';
            filtered.forEach(item => {
                html += `<tr>
                    <td class="p-6 font-bold text-slate-800">${item.tgl}<br><span class="text-[9px] text-orange-500 uppercase">${item.periode}</span></td>
                    <td class="p-6 font-semibold uppercase text-xs text-slate-600">${item.cabang}</td>
                    <td class="p-6 text-center font-bold text-slate-700">${item.jml_agt} Org</td>
                    <td class="p-6 text-right font-black text-slate-900">Rp ${(parseInt(item.total)||0).toLocaleString('id-ID')}</td>
                    <td class="p-6 text-center no-print">${item.foto !== "Tidak ada foto" ? `<a href="${item.foto}" target="_blank" class="text-blue-600 font-black text-[10px] uppercase">Lihat</a>` : '-'}</td>
                </tr>`;
            });
            document.getElementById('isi-tabel-iuran').innerHTML = html;
        }

        function tampilkanPengeluaran() {
            jalankanFilterPengeluaran();
        }

        function jalankanFilterPengeluaran() {
            const filterBulan = document.getElementById('filter-periode-keluar').value;
            const filtered = DATA_KELUAR.filter(item => {
                if (filterBulan === 'Semua Bulan') return true;
                if (!item.tgl) return false;
                
                // Cek apakah tanggal diawali dengan filter (YYYY-MM) 
                // atau mengandung bagian tahun-bulan (jika format DD/MM/YYYY)
                if (item.tgl.includes('-')) {
                    return item.tgl.startsWith(filterBulan);
                } else if (item.tgl.includes('/')) {
                    const parts = item.tgl.split('/');
                    const key = parts[2] + '-' + parts[1];
                    return key === filterBulan;
                }
                return false;
            });

            let html = '';
            filtered.forEach(item => {
                html += `<tr>
                    <td class="p-6 font-bold text-slate-800">${item.tgl}</td>
                    <td class="p-6 uppercase text-xs font-semibold text-slate-600">${item.keperluan}</td>
                    <td class="p-6 text-right font-black text-red-600">Rp ${(parseInt(item.nominal)||0).toLocaleString('id-ID')}</td>
                </tr>`;
            });
            if (filtered.length === 0) {
                html = '<tr><td colspan="3" class="p-6 text-center text-slate-400 italic font-bold">DATA PADA PERIODE INI MASIH KOSONG</td></tr>';
            }
            document.getElementById('isi-tabel-keluar').innerHTML = html;
        }

        function formatRupiah(input) {
            let value = input.value.replace(/[^,\d]/g, '').toString();
            let split = value.split(',');
            let sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            let ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            if (ribuan) { let separator = sisa ? '.' : ''; rupiah += separator + ribuan.join('.'); }
            input.value = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
        }

        function exportKeExcel() {
            if (typeof XLSX === 'undefined') { alert("Library Excel belum siap!"); return; }
            const tabel = document.getElementById('tabel-rekap');
            const isi = document.getElementById('isi-tabel-iuran');
            if (!isi || isi.rows.length === 0) { alert("‚ö†Ô∏è Data kosong!"); return; }
            try {
                const workbook = XLSX.utils.table_to_book(tabel, { sheet: "Data Rekap" });
                XLSX.writeFile(workbook, "Laporan_Iuran_PGRI.xlsx");
            } catch (err) { alert("Gagal: " + err.message); }
        }

        async function simpanPengeluaran() {
            const tgl = document.getElementById('exp-tgl').value;
            const nama = document.getElementById('exp-nama').value;
            const nominal = document.getElementById('exp-nominal').value.replace(/\./g, '');
            if(!tgl || !nama || !nominal) return alert("Lengkapi data!");
            const btn = document.getElementById('btn-save-exp');
            btn.innerText = "PROSES..."; btn.disabled = true;
            try {
                const response = await fetch(linkScript, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'pengeluaran', tgl: tgl, keperluan: nama, nominal: nominal })
                });
                const result = await response.json();
                if(result.result === "success") { alert("Tersimpan!"); location.reload(); }
                else { alert("Gagal: " + result.error); }
            } catch (e) { alert("Koneksi Error!"); btn.disabled = false; btn.innerText = "SIMPAN DATA"; }
        }

        function exportExcelPengeluaran() {
            if (typeof XLSX === 'undefined') { alert("Library Excel belum siap!"); return; }
            const tabel = document.getElementById('tabel-pengeluaran');
            const isi = document.getElementById('isi-tabel-keluar');
            if (!isi || isi.rows.length === 0) { alert("‚ö†Ô∏è Tidak ada data pengeluaran!"); return; }
            try {
                const wb = XLSX.utils.table_to_book(tabel, { sheet: "Laporan Pengeluaran" });
                const tgl = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
                XLSX.writeFile(wb, `Laporan_Pengeluaran_PGRI_${tgl}.xlsx`);
            } catch (err) { alert("Gagal: " + err.message); }
        }
    </script>
</body>
</html>
